{"ast":null,"code":"import _objectSpread from \"/Users/antoine/Documents/DGCCRF/dgccrf-front/node_modules/@babel/runtime/helpers/esm/objectSpread\";\n\n/* eslint-disable no-undef */\nimport PouchDB from 'pouchdb';\nimport PouchDBFind from 'pouchdb-find';\nimport replicateFromSQL from '../replicationHandler';\nimport config from '../../config';\nimport { optionalCallExpression } from '@babel/types';\nPouchDB.plugin(PouchDBFind);\n\nclass PouchDbVisiteService {\n  constructor(AGENT_DD_IDENT) {\n    this.resetDb = this.resetDb.bind(this);\n    this.initDb = this.initDb.bind(this);\n    this.changesCallbacks = [];\n    this.initDb(AGENT_DD_IDENT);\n  }\n\n  async resetDb(AGENT_DD_IDENT) {\n    this.controleReplication.stopReplication();\n    this.visiteReplication.stopReplication();\n    await this.controleDB.destroy();\n    await this.newControleDB.destroy();\n    await this.visiteDB.destroy();\n    await this.newVisiteDB.destroy();\n    await this.initDb(AGENT_DD_IDENT);\n  }\n\n  async initDb(AGENT_DD_IDENT) {\n    this.AGENT_DD_IDENT = AGENT_DD_IDENT;\n    var opts = {\n      batch_size: 1000,\n      live: true,\n      retry: true,\n      filter: 'filters/by_user',\n      query_params: {\n        AGENT_DD_IDENT: AGENT_DD_IDENT\n      }\n    };\n    var opts_without_filter = {\n      batch_size: 1000,\n      live: true,\n      retry: true\n    };\n    this.controleDB = new PouchDB('controles');\n    this.controleReplication = replicateFromSQL(this.controleDB, config.backend.base_url + '/fulldata/controles?idAgent=' + AGENT_DD_IDENT, 'controle_date');\n    this.controleDB.createIndex({\n      index: {\n        fields: ['DOSSIER_IDENT']\n      }\n    });\n    this.controleDB.changes({\n      since: 'now',\n      live: true\n    }).on('change', () => this.changesCallbacks.map(cb => cb()));\n    this.newVisiteDB = new PouchDB('new-visites');\n    this.newVisiteDB.replicate.to(config.couchDb.url_new_visites, optionalCallExpression);\n    this.newVisiteDB.replicate.from(config.couchDb.url_new_visites, opts_without_filter);\n    this.newVisiteDB.createIndex({\n      index: {\n        fields: ['VISITE_IDENT']\n      }\n    });\n    this.newVisiteDB.changes({\n      since: 'now',\n      live: true\n    }).on('change', () => this.changesCallbacks.map(cb => cb()));\n    this.newControleDB = new PouchDB('new-controles');\n    this.newControleDB.replicate.to(config.couchDb.url_new_controles, opts_without_filter);\n    this.newControleDB.replicate.from(config.couchDb.url_new_controles, opts);\n    this.newControleDB.createIndex({\n      index: {\n        fields: ['DOSSIER_IDENT']\n      }\n    });\n    this.newControleDB.createIndex({\n      index: {\n        fields: ['VISITE_IDENT']\n      }\n    });\n    this.newControleDB.changes({\n      since: 'now',\n      live: true\n    }).on('change', () => this.changesCallbacks.map(cb => cb()));\n    this.visiteDB = new PouchDB('visites');\n    this.visiteReplication = replicateFromSQL(this.visiteDB, config.backend.base_url + '/fulldata/visites?idAgent=' + AGENT_DD_IDENT, 'visite_date');\n    this.visiteDB.createIndex({\n      index: {\n        fields: ['VISTE_IDENT']\n      }\n    });\n    this.visiteDB.changes({\n      since: 'now',\n      live: true\n    }).on('change', () => this.changesCallbacks.map(cb => cb()));\n  } //call the callback on db changes\n\n\n  onChanges(cb) {\n    this.changesCallbacks.push(cb);\n  } //getAllDocsOfTheDB\n\n\n  async getAllDocs() {\n    let firstArray = await this.controleDB.allDocs({\n      include_docs: true,\n      descending: true\n    });\n    firstArray = firstArray.rows.map(item => item.doc);\n    let secondArray = await this.newControleDB.allDocs({\n      include_docs: true,\n      descending: true\n    });\n    secondArray = secondArray.rows.map(item => item.doc);\n    return secondArray.concat(firstArray).filter(item => !(item._id.split('/')[0] == '_design'));\n  }\n\n  async getControlesByDossier(dossierID) {\n    let firstArray = await this.controleDB.find({\n      selector: {\n        DOSSIER_IDENT: parseInt(dossierID)\n      }\n    });\n    firstArray = firstArray.docs;\n    let secondArray = await this.newControleDB.find({\n      selector: {\n        DOSSIER_IDENT: parseInt(dossierID)\n      }\n    });\n    secondArray = secondArray.docs;\n    return firstArray.concat(secondArray).filter((value, index, self) => self.indexOf(value) === index);\n  }\n\n  async getVisitesByDossier(dossierID) {\n    let controles = await this.getControlesByDossier(dossierID);\n    let visitesDic = {};\n\n    for (let controle of controles) {\n      visitesDic[controle.VISITE_IDENT] = visitesDic[controle.VISITE_IDENT] || [];\n      visitesDic[controle.VISITE_IDENT].push(controle);\n    }\n\n    let visitesList = Object.keys(visitesDic).map(async VISITE_IDENT => {\n      let visiteData = await this.visiteDB.find({\n        selector: {\n          VISITE_IDENT: parseInt(VISITE_IDENT)\n        }\n      }).then(table => table.docs[0]);\n\n      if (!visiteData) {\n        visiteData = await this.newVisiteDB.find({\n          selector: {\n            VISITE_IDENT: parseInt(VISITE_IDENT)\n          }\n        }).then(table => table.docs[0]);\n      }\n\n      if (visiteData) {\n        return {\n          visiteData,\n          controles: visitesDic[VISITE_IDENT]\n        };\n      }\n    });\n    visitesList = await Promise.all(visitesList); // eslint-disable-next-line no-undefa\n\n    return visitesList.filter(doc => doc);\n  }\n\n  postControlesByVisite(visiteInfos, controlesList) {\n    let promises = [];\n    const ident = parseInt(Date.now() + this.AGENT_DD_IDENT.toString());\n    promises.push(this.newVisiteDB.post(_objectSpread({}, visiteInfos, {\n      VISITE_IDENT: ident\n    })));\n\n    for (let controle of controlesList) {\n      promises.push(this.newControleDB.post(_objectSpread({}, visiteInfos, {\n        DOSSIER_IDENT: controle.dossier,\n        CPF_CODE_PRODUIT: controle.cpf,\n        STADE_PRODUIT_IDENT: parseInt(controle.stade),\n        CONTROLE_IDENT: controle.dossier.toString() + controle.cpf.toString(),\n        VISITE_IDENT: ident\n      })));\n    }\n\n    return Promise.all(promises);\n  }\n\n}\n\nexport default PouchDbVisiteService;","map":{"version":3,"sources":["/Users/antoine/Documents/DGCCRF/dgccrf-front/src/services/subservices/visite.service.js"],"names":["PouchDB","PouchDBFind","replicateFromSQL","config","optionalCallExpression","plugin","PouchDbVisiteService","constructor","AGENT_DD_IDENT","resetDb","bind","initDb","changesCallbacks","controleReplication","stopReplication","visiteReplication","controleDB","destroy","newControleDB","visiteDB","newVisiteDB","opts","batch_size","live","retry","filter","query_params","opts_without_filter","backend","base_url","createIndex","index","fields","changes","since","on","map","cb","replicate","to","couchDb","url_new_visites","from","url_new_controles","onChanges","push","getAllDocs","firstArray","allDocs","include_docs","descending","rows","item","doc","secondArray","concat","_id","split","getControlesByDossier","dossierID","find","selector","DOSSIER_IDENT","parseInt","docs","value","self","indexOf","getVisitesByDossier","controles","visitesDic","controle","VISITE_IDENT","visitesList","Object","keys","visiteData","then","table","Promise","all","postControlesByVisite","visiteInfos","controlesList","promises","ident","Date","now","toString","post","dossier","CPF_CODE_PRODUIT","cpf","STADE_PRODUIT_IDENT","stade","CONTROLE_IDENT"],"mappings":"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","sourcesContent":["/* eslint-disable no-undef */\nimport PouchDB from 'pouchdb';\nimport PouchDBFind from 'pouchdb-find';\nimport replicateFromSQL from '../replicationHandler';\nimport config from '../../config';\nimport { optionalCallExpression } from '@babel/types';\nPouchDB.plugin(PouchDBFind);\n\nclass PouchDbVisiteService {\n  constructor(AGENT_DD_IDENT) {\n    this.resetDb = this.resetDb.bind(this);\n    this.initDb = this.initDb.bind(this);\n    this.changesCallbacks = [];\n    this.initDb(AGENT_DD_IDENT);\n  }\n\n  async resetDb(AGENT_DD_IDENT) {\n    this.controleReplication.stopReplication();\n    this.visiteReplication.stopReplication();\n    await this.controleDB.destroy();\n    await this.newControleDB.destroy();\n    await this.visiteDB.destroy();\n    await this.newVisiteDB.destroy();\n    await this.initDb(AGENT_DD_IDENT);\n  }\n\n  async initDb(AGENT_DD_IDENT) {\n    this.AGENT_DD_IDENT = AGENT_DD_IDENT;\n    var opts = {\n      batch_size: 1000,\n      live: true,\n      retry: true,\n      filter: 'filters/by_user',\n      query_params: { AGENT_DD_IDENT: AGENT_DD_IDENT }\n    };\n\n    var opts_without_filter = {\n      batch_size: 1000,\n      live: true,\n      retry: true\n    };\n\n    this.controleDB = new PouchDB('controles');\n    this.controleReplication = replicateFromSQL(this.controleDB, config.backend.base_url + '/fulldata/controles?idAgent=' + AGENT_DD_IDENT, 'controle_date');\n    this.controleDB.createIndex({\n      index: { fields: ['DOSSIER_IDENT'] }\n    });\n    this.controleDB.changes({ since: 'now', live: true })\n      .on('change', () => this.changesCallbacks.map(cb => cb()));\n\n    this.newVisiteDB = new PouchDB('new-visites');\n    this.newVisiteDB.replicate.to(config.couchDb.url_new_visites, optionalCallExpression);\n    this.newVisiteDB.replicate.from(config.couchDb.url_new_visites, opts_without_filter);\n    this.newVisiteDB.createIndex({\n      index: { fields: ['VISITE_IDENT'] }\n    });\n    this.newVisiteDB.changes({ since: 'now', live: true })\n      .on('change', () => this.changesCallbacks.map(cb => cb()));\n\n    this.newControleDB = new PouchDB('new-controles');\n    this.newControleDB.replicate.to(config.couchDb.url_new_controles, opts_without_filter);\n    this.newControleDB.replicate.from(config.couchDb.url_new_controles, opts);\n    this.newControleDB.createIndex({ index: { fields: ['DOSSIER_IDENT'] } });\n    this.newControleDB.createIndex({ index: { fields: ['VISITE_IDENT'] } });\n    this.newControleDB.changes({ since: 'now', live: true })\n      .on('change', () => this.changesCallbacks.map(cb => cb()));\n\n    this.visiteDB = new PouchDB('visites');\n    this.visiteReplication = replicateFromSQL(this.visiteDB, config.backend.base_url + '/fulldata/visites?idAgent=' + AGENT_DD_IDENT, 'visite_date');\n    this.visiteDB.createIndex({\n      index: { fields: ['VISTE_IDENT'] }\n    });\n    this.visiteDB.changes({ since: 'now', live: true })\n      .on('change', () => this.changesCallbacks.map(cb => cb()));\n  }\n\n  //call the callback on db changes\n  onChanges(cb) {\n    this.changesCallbacks.push(cb);\n  }\n\n  //getAllDocsOfTheDB\n  async getAllDocs() {\n    let firstArray = await this.controleDB.allDocs({ include_docs: true, descending: true });\n    firstArray = firstArray.rows.map(item => item.doc);\n    let secondArray = await this.newControleDB.allDocs({ include_docs: true, descending: true });\n    secondArray = secondArray.rows.map(item => item.doc);\n\n    return secondArray.concat(firstArray).filter(item => !(item._id.split('/')[0] == '_design'));\n  }\n\n  async getControlesByDossier(dossierID) {\n    let firstArray = await this.controleDB.find({ selector: { DOSSIER_IDENT: parseInt(dossierID) } });\n    firstArray = firstArray.docs;\n    let secondArray = await this.newControleDB.find({ selector: { DOSSIER_IDENT: parseInt(dossierID) } });\n    secondArray = secondArray.docs;\n    return firstArray.concat(secondArray).filter((value, index, self) => self.indexOf(value) === index);\n  }\n\n  async getVisitesByDossier(dossierID) {\n    let controles = await this.getControlesByDossier(dossierID);\n    let visitesDic = {};\n    for (let controle of controles) {\n      visitesDic[controle.VISITE_IDENT] =\n        visitesDic[controle.VISITE_IDENT] || [];\n      visitesDic[controle.VISITE_IDENT].push(controle);\n    }\n    let visitesList = Object.keys(visitesDic).map(async VISITE_IDENT => {\n      let visiteData = await this.visiteDB\n        .find({ selector: { VISITE_IDENT: parseInt(VISITE_IDENT) } })\n        .then(table => table.docs[0]);\n      if (!visiteData) {\n        visiteData = await this.newVisiteDB\n          .find({ selector: { VISITE_IDENT: parseInt(VISITE_IDENT) } })\n          .then(table => table.docs[0]);\n      }\n      if (visiteData) {\n        return {\n          visiteData,\n          controles: visitesDic[VISITE_IDENT]\n        };\n      }\n    });\n    visitesList = await Promise.all(visitesList);\n    // eslint-disable-next-line no-undefa\n    return visitesList.filter(doc => doc);\n  }\n\n  postControlesByVisite(visiteInfos, controlesList) {\n    let promises = [];\n    const ident = parseInt(Date.now() + this.AGENT_DD_IDENT.toString());\n    promises.push(\n      this.newVisiteDB.post({\n        ...visiteInfos,\n        VISITE_IDENT: ident\n      })\n    );\n    for (let controle of controlesList) {\n      promises.push(\n        this.newControleDB.post({\n          ...visiteInfos,\n          DOSSIER_IDENT: controle.dossier,\n          CPF_CODE_PRODUIT: controle.cpf,\n          STADE_PRODUIT_IDENT: parseInt(controle.stade),\n          CONTROLE_IDENT: controle.dossier.toString() + controle.cpf.toString(),\n          VISITE_IDENT: ident\n        })\n      );\n    }\n    return Promise.all(promises);\n  }\n}\n\nexport default PouchDbVisiteService;\n"]},"metadata":{},"sourceType":"module"}